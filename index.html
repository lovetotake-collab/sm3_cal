<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMë¼ì¸ ë§¤ë§¤ ê³„ì‚°ê¸° v4 (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        .line-item {
            padding: 12px;
            margin: 6px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: all 0.2s;
        }
        .line-item:hover {
            transform: translateX(4px);
        }
        .sm-line { background: #dcfce7; border-left: 4px solid #22c55e; }
        .sm2-line { background: #fef9c3; border-left: 4px solid #eab308; }
        .sm3-line { background: #fed7aa; border-left: 4px solid #f97316; }
        .sm4-line { background: #fecdd3; border-left: 4px solid #dc2626; }
        .sell-line { background: #fecaca; border-left: 4px solid #ef4444; }
        .buy-point { background: #fee2e2; border: 2px solid #ef4444; font-weight: 700; }
        .sell-point { background: #dbeafe; border: 2px solid #3b82f6; font-weight: 700; }
        
        input[type="text"], input[type="number"] {
            border: 2px solid #e5e7eb;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .input-gray { background: #f3f4f6; border-color: #9ca3af; }
        .input-red { background: #fee2e2; border-color: #fca5a5; }
        .input-blue { background: #dbeafe; border-color: #93c5fd; }
        .input-purple { background: #e9d5ff; border-color: #c084fc; }
        .input-green { background: #d1fae5; border-color: #6ee7b7; }
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-calculate:active {
            transform: translateY(0);
        }
        .btn-reset {
            background: #6b7280;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-reset:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }
        
        .stock-list-item {
            background: #f9fafb;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .stock-list-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }
        .stock-list-item.selected {
            background: #e0e7ff;
            border-color: #667eea;
        }
        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .drag-handle {
            cursor: move;
            color: #9ca3af;
            padding: 0 8px;
            user-select: none;
        }
        .drag-handle:hover {
            color: #667eea;
        }
        
        .dragging {
            opacity: 0.5;
            background: #f3f4f6;
        }
        
        .summary-box {
            background: #fef9c3;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #facc15;
            margin-bottom: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th {
            background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #667eea;
            position: sticky;
            top: 0;
        }
        table td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        table tr:hover {
            background: #f9fafb;
        }
        
        @media (max-width: 768px) {
            .grid.grid-cols-4 { grid-template-columns: 1fr 1fr; }
            .grid.grid-cols-3 { grid-template-columns: 1fr; }
            input { font-size: 14px; }
            .line-item { font-size: 14px; padding: 10px; }
        }
            
        .btn-google {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-google:hover {
            background: #357ae8;
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-backup:hover:not(:disabled) {
            background: #059669;
        }
        .btn-backup:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-load {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-load:hover:not(:disabled) {
            background: #d97706;
        }
        .btn-load:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        .sync-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        .sync-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        .sync-status.syncing {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <!-- í—¤ë” -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                        ğŸ“Š SMë¼ì¸ ë§¤ë§¤ ê³„ì‚°ê¸° v4
                    </h1>
                    <p class="text-gray-600 mt-2">ì¤‘ë“± ê´€ë¦¬ ê¸°ëŠ¥ì´ ì¶”ê°€ëœ ê³ ê¸‰ ë²„ì „ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë™ê¸°í™”)</p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex gap-2">
                        <button id="backupBtn" class="btn-backup" onclick="manualBackup()" disabled>
                            <span>ğŸ’¾</span>
                            <span>ë°±ì—…</span>
                        </button>
                        <button id="loadBtn" class="btn-load" onclick="manualLoad()" disabled>
                            <span>ğŸ“¥</span>
                            <span>ë¡œë“œ</span>
                        </button>
                        <button id="googleSignInBtn" class="btn-google" onclick="handleAuthClick()">
                            <svg width="18" height="18" viewBox="0 0 18 18">
                                <path fill="#fff" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                                <path fill="#fff" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                                <path fill="#fff" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                                <path fill="#fff" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                            </svg>
                            <span id="googleBtnText">êµ¬ê¸€ ë¡œê·¸ì¸</span>
                        </button>
                    </div>
                    <div id="syncStatus" class="sync-status disconnected">
                        <span>â—</span>
                        <span id="statusText">ì—°ê²° ì•ˆë¨</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs text-gray-500"></div>
                </div>
            </div>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“ ì¢…ëª© ì •ë³´ ì…ë ¥</h2>
            <div class="grid grid-cols-4 gap-3">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-600">ì¢…ëª©ëª…</label>
                    <input type="text" id="stockName" placeholder="ì¢…ëª©ëª… ì…ë ¥" class="input-gray">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-red-600">ê³ ê°€ (â‚©)</label>
                    <input type="text" id="highPrice" placeholder="ê³ ê°€ ì…ë ¥" class="input-red">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-blue-600">ì €ê°€ (â‚©)</label>
                    <input type="text" id="lowPrice" placeholder="ì €ê°€ ì…ë ¥" class="input-blue">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-purple-600">ë°˜ë“±ì €ê°€ (â‚©) <span class="text-xs text-gray-400">ì„ íƒ</span></label>
                    <input type="text" id="bouncePrice" placeholder="ì„ íƒì‚¬í•­" class="input-purple">
                </div>
            </div>
            <div class="grid grid-cols-4 gap-3 mt-3">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-green-600">ìˆ˜ì •ì €ê°€ (â‚©) <span class="text-xs text-gray-400">ì„ íƒ</span></label>
                    <input type="text" id="adjustedPrice" placeholder="ì„ íƒì‚¬í•­" class="input-green">
                </div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-3">
                <button class="btn-calculate" onclick="calculate()">
                    âœ… ê³„ì‚°í•˜ê¸°
                </button>
                <button class="btn-calculate" onclick="addToList()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ğŸ’¾ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                </button>
                <button class="btn-reset" onclick="resetInputs()">
                    ğŸ”„ ì…ë ¥ ì´ˆê¸°í™”
                </button>
            </div>
            <div class="mt-3 text-sm text-gray-600 bg-purple-50 p-3 rounded-lg border border-purple-200">
                ğŸ’¡ <strong>íŒ:</strong> ê³ ê°€, ì €ê°€ë§Œ ì…ë ¥í•´ë„ SMë¼ì¸ê³¼ ë§¤ìˆ˜íƒ€ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë“±ì´ ë‚˜ì˜¤ë©´ ë°˜ë“±ì €ê°€ë¥¼ ì…ë ¥í•˜ì—¬ ë§¤ë„íƒ€ì ì„ í™•ì¸í•˜ì„¸ìš”.
            </div>
        </div>

        <!-- ì¢…ëª© ë¦¬ìŠ¤íŠ¸ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“‹ ì €ì¥ëœ ì¢…ëª© ë¦¬ìŠ¤íŠ¸</h2>
            <div class="text-sm text-gray-600 mb-3">
                ì¢…ëª©ì„ í´ë¦­í•˜ë©´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤
            </div>
            <div id="stockList" class="max-h-[400px] overflow-y-auto">
                <div class="text-center text-gray-400 py-8">
                    ì•„ì§ ì €ì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                    "ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì €ì¥í•˜ì„¸ìš”.
                </div>
            </div>
        </div>

        <!-- ê³„ì‚° ê²°ê³¼ ì˜ì—­ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <!-- ë§¤ë§¤íƒ€ì  ìš”ì•½ -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ¯ ë§¤ë§¤íƒ€ì  ìš”ì•½</h2>
                <div class="summary-box">
                    <div class="grid grid-cols-2 gap-3" id="tradingSummary">
                        <div class="text-center">
                            <div class="text-sm text-gray-600 mb-1">ì¢…ëª©ëª…</div>
                            <div class="font-bold text-lg" id="summaryStock">-</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-600 mb-1">ë°˜ë“±í­</div>
                            <div class="font-bold text-lg text-purple-600" id="summaryBounce">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <h3 class="font-bold text-red-600 mb-2">ğŸ”´ ë§¤ìˆ˜ íƒ€ì  & ì†ì ˆ</h3>
                        <div id="buyPoints"></div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold text-blue-600 mb-2">ğŸ”µ ë§¤ë„ íƒ€ì </h3>
                        <div id="sellPoints"></div>
                    </div>
                </div>
            </div>

            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“Š ê¸°ë³¸ ì •ë³´</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-600">ê°€ê²©ì°¨</div>
                        <div class="text-xl font-bold" id="priceDiff">-</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-600">ìƒìŠ¹ë¥ </div>
                        <div class="text-xl font-bold text-green-600" id="riseRate">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SM ë¼ì¸ë“¤ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <!-- SM ë¼ì¸ -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-3 text-gray-700">ğŸŸ¢ SMë¼ì¸ (ë…¹ìƒ‰ë“±ë¶„ì„ )</h2>
                <div id="smLines"></div>
            </div>

            <!-- SM2 ë¼ì¸ -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-3 text-gray-700">ğŸŸ¡ SM2ë¼ì¸ (ë…¸ë€ë“±ë¶„ì„ )</h2>
                <div id="sm2Lines"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <!-- SM3 ë¼ì¸ -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-3 text-gray-700">ğŸŸ  SM3ë¼ì¸ (ë¹¨ê°„4ë“±ë¶„ì„ )</h2>
                <div id="sm3Lines"></div>
            </div>

            <!-- SM4 ë¼ì¸ -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-3 text-gray-700">ğŸ”´ SM4ë¼ì¸ (ì†ì ˆë¼ì¸)</h2>
                <div id="sm4Lines"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <!-- ë§¤ë„ ë¼ì¸ -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-3 text-gray-700">ğŸ’™ ë§¤ë„ë¼ì¸</h2>
                <div id="sellLines"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ì„¤ì • ==========
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'sm3_cal.json';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isSignedIn = false;
        let driveFileId = null;
        let tokenRefreshTimer = null;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const btn = document.getElementById('googleSignInBtn');
                if (btn) btn.disabled = false;
            }
        }

        function handleAuthClick() {
            if (isSignedIn) {
                handleSignoutClick();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    
                    localStorage.setItem('google_access_token_smline', resp.access_token);
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('google_token_expiry_smline', expiryTime.toString());
                        setupTokenRefresh(resp.expires_in);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    await loadFromGoogleDrive();
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            
            localStorage.removeItem('google_access_token_smline');
            localStorage.removeItem('google_token_expiry_smline');
            
            isSignedIn = false;
            updateSyncStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
            document.getElementById('googleBtnText').textContent = 'êµ¬ê¸€ ë¡œê·¸ì¸';
            document.getElementById('lastSyncTime').textContent = '';
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
        }

        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token_smline');
            const tokenExpiry = localStorage.getItem('google_token_expiry_smline');
            
            if (savedToken && tokenExpiry) {
                if (Date.now() < parseInt(tokenExpiry)) {
                    gapi.client.setToken({
                        access_token: savedToken
                    });
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    
                    const remainingSeconds = Math.floor((parseInt(tokenExpiry) - Date.now()) / 1000);
                    setupTokenRefresh(remainingSeconds);
                    
                    await loadFromGoogleDrive();
                } else {
                    localStorage.removeItem('google_access_token_smline');
                    localStorage.removeItem('google_token_expiry_smline');
                }
            }
        }

        function setupTokenRefresh(expiresInSeconds) {
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                localStorage.setItem('google_access_token_smline', resp.access_token);
                                if (resp.expires_in) {
                                    const expiryTime = Date.now() + (resp.expires_in * 1000);
                                    localStorage.setItem('google_token_expiry_smline', expiryTime.toString());
                                    setupTokenRefresh(resp.expires_in);
                                }
                                
                                gapi.client.setToken({
                                    access_token: resp.access_token
                                });
                                
                                console.log('í† í°ì´ ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        };
                        
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        console.error('í† í° ìë™ ê°±ì‹  ì‹¤íŒ¨:', err);
                    }
                }
            }, refreshTime);
        }

        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('statusText');
            if (statusEl && textEl) {
                statusEl.className = `sync-status ${status}`;
                textEl.textContent = text;
            }
        }

        function updateLastSyncTime() {
            const el = document.getElementById('lastSyncTime');
            if (el) {
                const now = new Date();
                const timeStr = now.toLocaleString('ko-KR');
                el.textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${timeStr}`;
            }
        }

        async function findDriveFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                }
                return null;
            } catch (err) {
                console.error('íŒŒì¼ ê²€ìƒ‰ ì˜¤ë¥˜:', err);
                return null;
            }
        }

        async function loadFromGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                driveFileId = await findDriveFile();
                
                if (driveFileId) {
                    const response = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media',
                    });
                    
                    stockDatabase = JSON.parse(response.body);
                    localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
                    renderStockList();
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    updateLastSyncTime();
                } else {
                    updateSyncStatus('connected', 'ì—°ê²°ë¨ (íŒŒì¼ ì—†ìŒ)');
                }
            } catch (err) {
                console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
            }
        }

        async function saveToGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
            
            try {
                const data = JSON.stringify(stockDatabase, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                
                if (driveFileId) {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                } else {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    
                    const result = await response.json();
                    driveFileId = result.id;
                }
                
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
                updateLastSyncTime();
            } catch (err) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨ (ì €ì¥ ì‹¤íŒ¨)');
            }
        }

        async function manualBackup() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await saveToGoogleDrive();
                alert('ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        async function manualLoad() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) {
                await loadFromGoogleDrive();
                alert('ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!');
            }
        }

        let stockDatabase = JSON.parse(localStorage.getItem('smStocks') || '[]');
        let currentSelectedIndex = -1;
        let draggedIndex = null;

        function getTickSize(price) {
            if (price < 2000) return 1;
            if (price < 5000) return 5;
            if (price < 20000) return 10;
            if (price < 50000) return 50;
            if (price < 200000) return 100;
            if (price < 500000) return 500;
            return 1000;
        }

        function adjustBuyPrice(price) {
            const tickSize = getTickSize(price);
            return Math.ceil(price / tickSize) * tickSize;
        }

        function adjustSellPrice(price) {
            const tickSize = getTickSize(price);
            return Math.floor(price / tickSize) * tickSize;
        }

        function formatPrice(price) {
            return 'â‚©' + Math.round(price).toLocaleString('ko-KR');
        }

        function formatInputPrice(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value) {
                input.value = parseInt(value).toLocaleString('ko-KR');
            }
        }

        function parseInputPrice(input) {
            const value = input.value.replace(/,/g, '');
            return value ? parseFloat(value) : NaN;
        }

        function resetInputs() {
            document.getElementById('stockName').value = '';
            document.getElementById('highPrice').value = '';
            document.getElementById('lowPrice').value = '';
            document.getElementById('bouncePrice').value = '';
            document.getElementById('adjustedPrice').value = '';
            
            document.getElementById('summaryStock').textContent = '-';
            document.getElementById('summaryBounce').textContent = '-';
            document.getElementById('priceDiff').textContent = '-';
            document.getElementById('riseRate').textContent = '-';
            document.getElementById('buyPoints').innerHTML = '';
            document.getElementById('sellPoints').innerHTML = '';
            document.getElementById('smLines').innerHTML = '';
            document.getElementById('sm2Lines').innerHTML = '';
            document.getElementById('sm3Lines').innerHTML = '';
            document.getElementById('sm4Lines').innerHTML = '';
            document.getElementById('sellLines').innerHTML = '';
            
            currentSelectedIndex = -1;
            renderStockList();
        }

        function calculate() {
            const stockName = document.getElementById('stockName').value || 'ì¢…ëª©';
            const high = parseInputPrice(document.getElementById('highPrice'));
            const low = parseInputPrice(document.getElementById('lowPrice'));
            const bounceInput = document.getElementById('bouncePrice');
            const bounce = bounceInput.value ? parseInputPrice(bounceInput) : null;
            const adjustedInput = document.getElementById('adjustedPrice');
            const adjusted = adjustedInput.value ? parseInputPrice(adjustedInput) : null;

            if (isNaN(high) || isNaN(low)) {
                alert('ê³ ê°€ì™€ ì €ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (high <= low) {
                alert('ê³ ê°€ëŠ” ì €ê°€ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            if (bounce !== null && bounce >= low) {
                alert('ë°˜ë“±ì €ê°€ëŠ” ì €ê°€ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            const priceDiff = high - low;
            const unit = priceDiff / 4;
            const riseRate = (priceDiff / low * 100).toFixed(2);

            document.getElementById('priceDiff').textContent = formatPrice(priceDiff);
            document.getElementById('riseRate').textContent = riseRate + '%';
            document.getElementById('summaryStock').textContent = stockName;
            
            const effectiveLow = adjusted !== null ? adjusted : low;
            
            let bounceRate = null;
            if (bounce !== null) {
                bounceRate = ((effectiveLow - bounce) / effectiveLow * 100).toFixed(1);
                document.getElementById('summaryBounce').textContent = bounceRate + '%';
            } else {
                document.getElementById('summaryBounce').textContent = '-';
            }

            const smLines = [
                { name: '1ë¼ì¸', price: high },
                { name: '2ë¼ì¸', price: high - unit },
                { name: '3ë¼ì¸', price: high - unit * 2 },
                { name: '4ë¼ì¸', price: high - unit * 3 },
                { name: '5ë¼ì¸', price: low }
            ];

            const sm2Lines = [
                { name: '1ë¼ì¸', price: effectiveLow },
                { name: '2ë¼ì¸', price: effectiveLow - unit },
                { name: '3ë¼ì¸', price: effectiveLow - unit * 2 },
                { name: '4ë¼ì¸', price: effectiveLow - unit * 3, extra: 'â† 1ì°¨ ë§¤ìˆ˜' },
                { name: '5ë¼ì¸', price: effectiveLow - priceDiff, extra: 'â† 2ì°¨ ë§¤ìˆ˜' }
            ];

            const sm3Start = sm2Lines[4].price;
            const sm3Lines = [
                { name: '1ë¼ì¸', price: sm3Start },
                { name: '2ë¼ì¸', price: sm3Start - unit },
                { name: '3ë¼ì¸', price: sm3Start - unit * 2 },
                { name: '4ë¼ì¸', price: sm3Start - unit * 3, extra: 'â† 3ì°¨ ë§¤ìˆ˜' },
                { name: '5ë¼ì¸', price: sm3Start - priceDiff, extra: 'â† 4ì°¨ ë§¤ìˆ˜' }
            ];

            const sm4Start = sm3Lines[4].price;
            const sm4Lines = [
                { name: '1ë¼ì¸', price: sm4Start },
                { name: '2ë¼ì¸', price: sm4Start - unit, extra: 'â† ì†ì ˆ' },
                { name: '3ë¼ì¸', price: sm4Start - unit * 2 },
                { name: '4ë¼ì¸', price: sm4Start - unit * 3 },
                { name: '5ë¼ì¸', price: sm4Start - priceDiff }
            ];

            displayLines('smLines', smLines, 'sm-line');
            displayLines('sm2Lines', sm2Lines, 'sm2-line');
            displayLines('sm3Lines', sm3Lines, 'sm3-line');
            displayLines('sm4Lines', sm4Lines, 'sm4-line');
            
            displayBuyPoints(sm2Lines, sm3Lines, sm4Lines);
            
            if (bounce !== null) {
                const sellDiff = effectiveLow - bounce;
                const sellUnit = sellDiff / 4;
                const sellLines = [
                    { name: '1ë¼ì¸', price: effectiveLow },
                    { name: '2ë¼ì¸', price: effectiveLow - sellUnit, extra: 'â† 2ì°¨ ë§¤ë„' },
                    { name: '3ë¼ì¸', price: effectiveLow - sellUnit * 2, extra: 'â† 1ì°¨ ë§¤ë„' },
                    { name: '4ë¼ì¸', price: effectiveLow - sellUnit * 3 },
                    { name: '5ë¼ì¸', price: bounce }
                ];
                
                displayLines('sellLines', sellLines, 'sell-line');
                displaySellPoints(sellLines, bounceRate);
            } else {
                document.getElementById('sellLines').innerHTML = '<div class="text-center text-gray-500 py-4">ë°˜ë“±ì €ê°€ë¥¼ ì…ë ¥í•˜ë©´ ë§¤ë„ë¼ì¸ì´ í‘œì‹œë©ë‹ˆë‹¤</div>';
                document.getElementById('sellPoints').innerHTML = '<div class="text-center text-gray-500 py-4">ë°˜ë“±ì €ê°€ë¥¼ ì…ë ¥í•˜ë©´ ë§¤ë„íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤</div>';
            }
        }

        function displayLines(elementId, lines, className) {
            document.getElementById(elementId).innerHTML = lines.map(line => {
                const extra = line.extra ? `<span class="text-red-600 font-bold ml-2">${line.extra}</span>` : '';
                return `
                    <div class="line-item ${className}">
                        <div>
                            <span class="font-bold">${line.name}</span>
                            ${extra}
                        </div>
                        <div class="text-lg font-bold">${formatPrice(line.price)}</div>
                    </div>
                `;
            }).join('');
        }

        function displayBuyPoints(sm2Lines, sm3Lines, sm4Lines) {
            const buyPoints = [
                { name: '1ì°¨ ë§¤ìˆ˜', price: adjustBuyPrice(sm2Lines[3].price), desc: 'SM2ë¼ì¸ 4ë¼ì¸', type: 'buy' },
                { name: '2ì°¨ ë§¤ìˆ˜', price: adjustBuyPrice(sm2Lines[4].price), desc: 'SM2ë¼ì¸ 5ë¼ì¸', type: 'buy' },
                { name: '3ì°¨ ë§¤ìˆ˜', price: adjustBuyPrice(sm3Lines[3].price), desc: 'SM3ë¼ì¸ 4ë¼ì¸', type: 'buy' },
                { name: '4ì°¨ ë§¤ìˆ˜', price: adjustBuyPrice(sm3Lines[4].price), desc: 'SM3ë¼ì¸ 5ë¼ì¸', type: 'buy' },
                { name: 'ì†ì ˆ', price: adjustSellPrice(sm4Lines[1].price), desc: 'SM4ë¼ì¸ 2ë¼ì¸', type: 'loss' }
            ];

            document.getElementById('buyPoints').innerHTML = buyPoints.map(point => {
                const bgColor = point.type === 'loss' ? 'bg-gray-100 border-gray-400' : 'buy-point';
                const textColor = point.type === 'loss' ? 'text-gray-700' : 'text-red-600';
                return `
                    <div class="line-item ${bgColor} mb-2">
                        <div>
                            <div class="font-bold">${point.name}</div>
                            <div class="text-xs text-gray-600">${point.desc}</div>
                        </div>
                        <div class="text-xl font-bold ${textColor}">${formatPrice(point.price)}</div>
                    </div>
                `;
            }).join('');
        }

        function displaySellPoints(sellLines, bounceRate) {
            const sellPoints = [
                { name: '1ì°¨ ë§¤ë„', price: adjustSellPrice(sellLines[2].price), desc: `ë§¤ë„ë¼ì¸ 3ë¼ì¸ (ë°˜ë“±í­ ${bounceRate}%)` },
                { name: '2ì°¨ ë§¤ë„', price: adjustSellPrice(sellLines[1].price), desc: `ë§¤ë„ë¼ì¸ 2ë¼ì¸ (ë°˜ë“±í­ ${bounceRate}%)` }
            ];

            document.getElementById('sellPoints').innerHTML = sellPoints.map(point => `
                <div class="line-item sell-point mb-2">
                    <div>
                        <div class="font-bold">${point.name}</div>
                        <div class="text-xs text-gray-600">${point.desc}</div>
                    </div>
                    <div class="text-xl font-bold text-blue-600">${formatPrice(point.price)}</div>
                </div>
            `).join('');
        }

        function addToList() {
            const stockName = document.getElementById('stockName').value;
            const high = parseInputPrice(document.getElementById('highPrice'));
            const low = parseInputPrice(document.getElementById('lowPrice'));
            const bounceInput = document.getElementById('bouncePrice');
            const bounce = bounceInput.value ? parseInputPrice(bounceInput) : null;
            const adjustedInput = document.getElementById('adjustedPrice');
            const adjusted = adjustedInput.value ? parseInputPrice(adjustedInput) : null;

            if (!stockName || isNaN(high) || isNaN(low)) {
                alert('ì¢…ëª©ëª…, ê³ ê°€, ì €ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const stockData = {
                name: stockName,
                high: high,
                low: low,
                bounce: bounce,
                adjusted: adjusted,
                timestamp: new Date().toISOString()
            };

            const existingIndex = stockDatabase.findIndex(stock => stock.name === stockName);
            
            if (existingIndex !== -1) {
                stockDatabase[existingIndex] = stockData;
                alert(`"${stockName}" ì¢…ëª© ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                stockDatabase.unshift(stockData);
                alert(`"${stockName}" ì¢…ëª©ì´ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }
            
            localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
            saveToGoogleDrive();
            renderStockList();
        }

        function renderStockList() {
            const listElement = document.getElementById('stockList');
            
            if (stockDatabase.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        ì•„ì§ ì €ì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        "ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì €ì¥í•˜ì„¸ìš”.
                    </div>
                `;
                return;
            }

            listElement.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gradient-to-r from-purple-100 to-blue-100 border-b-2 border-purple-300">
                                <th class="p-3 text-left font-bold" style="width: 30px;">â‹®</th>
                                <th class="p-3 text-left font-bold">ì¢…ëª©ëª…</th>
                                <th class="p-3 text-center font-bold text-red-600">1ì°¨ë§¤ìˆ˜</th>
                                <th class="p-3 text-center font-bold text-red-600">2ì°¨ë§¤ìˆ˜</th>
                                <th class="p-3 text-center font-bold text-red-600">3ì°¨ë§¤ìˆ˜</th>
                                <th class="p-3 text-center font-bold text-red-600">4ì°¨ë§¤ìˆ˜</th>
                                <th class="p-3 text-center font-bold text-blue-600">1ì°¨ë§¤ë„</th>
                                <th class="p-3 text-center font-bold text-blue-600">2ì°¨ë§¤ë„</th>
                                <th class="p-3 text-center font-bold text-gray-700">ì†ì ˆ</th>
                                <th class="p-3 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stockDatabase.map((stock, index) => {
                                const selected = index === currentSelectedIndex ? 'bg-purple-100' : '';
                                
                                const effectiveLow = stock.adjusted !== null ? stock.adjusted : stock.low;
                                const priceDiff = stock.high - stock.low;
                                const unit = priceDiff / 4;
                                
                                const buy1 = adjustBuyPrice(effectiveLow - unit * 3);
                                const buy2 = adjustBuyPrice(effectiveLow - priceDiff);
                                const buy3 = adjustBuyPrice(buy2 - unit * 3);
                                const buy4 = adjustBuyPrice(buy2 - priceDiff);
                                const stopLoss = adjustSellPrice(buy4 - unit);
                                
                                let sell1 = '-', sell2 = '-';
                                if (stock.bounce !== null) {
                                    const sellDiff = effectiveLow - stock.bounce;
                                    const sellUnit = sellDiff / 4;
                                    sell1 = formatPrice(adjustSellPrice(effectiveLow - sellUnit * 2));
                                    sell2 = formatPrice(adjustSellPrice(effectiveLow - sellUnit));
                                }
                                
                                return `
                                    <tr class="${selected} hover:bg-purple-50 cursor-pointer border-b transition-colors"
                                        draggable="true"
                                        ondragstart="handleDragStart(event, ${index})"
                                        ondragover="handleDragOver(event)"
                                        ondrop="handleDrop(event, ${index})"
                                        ondragend="handleDragEnd(event)"
                                        onclick="loadStock(${index})">
                                        <td class="drag-handle p-3" onclick="event.stopPropagation()">â‹®â‹®</td>
                                        <td class="p-3 font-bold">${stock.name}</td>
                                        <td class="p-3 text-center text-red-600 font-semibold">${formatPrice(buy1)}</td>
                                        <td class="p-3 text-center text-red-600 font-semibold">${formatPrice(buy2)}</td>
                                        <td class="p-3 text-center text-red-600 font-semibold">${formatPrice(buy3)}</td>
                                        <td class="p-3 text-center text-red-600 font-semibold">${formatPrice(buy4)}</td>
                                        <td class="p-3 text-center text-blue-600 font-semibold">${sell1}</td>
                                        <td class="p-3 text-center text-blue-600 font-semibold">${sell2}</td>
                                        <td class="p-3 text-center text-gray-600 font-semibold">${formatPrice(stopLoss)}</td>
                                        <td class="p-3 text-center">
                                            <button class="delete-btn" onclick="deleteStock(${index}, event)">ì‚­ì œ</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function handleDragStart(e, index) {
            draggedIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e, targetIndex) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedIndex === null || draggedIndex === targetIndex) {
                return false;
            }

            const draggedItem = stockDatabase[draggedIndex];
            stockDatabase.splice(draggedIndex, 1);
            stockDatabase.splice(targetIndex, 0, draggedItem);

            if (currentSelectedIndex === draggedIndex) {
                currentSelectedIndex = targetIndex;
            } else if (draggedIndex < currentSelectedIndex && targetIndex >= currentSelectedIndex) {
                currentSelectedIndex--;
            } else if (draggedIndex > currentSelectedIndex && targetIndex <= currentSelectedIndex) {
                currentSelectedIndex++;
            }

            localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
            saveToGoogleDrive();
            renderStockList();
            
            return false;
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedIndex = null;
        }

        function loadStock(index) {
            currentSelectedIndex = index;
            const stock = stockDatabase[index];
            
            document.getElementById('stockName').value = stock.name;
            document.getElementById('highPrice').value = stock.high.toLocaleString('ko-KR');
            document.getElementById('lowPrice').value = stock.low.toLocaleString('ko-KR');
            document.getElementById('bouncePrice').value = stock.bounce !== null ? stock.bounce.toLocaleString('ko-KR') : '';
            document.getElementById('adjustedPrice').value = stock.adjusted !== null ? stock.adjusted.toLocaleString('ko-KR') : '';
            
            calculate();
            renderStockList();
        }

        function deleteStock(index, event) {
            event.stopPropagation();
            
            const stock = stockDatabase[index];
            if (confirm(`"${stock.name}" ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                stockDatabase.splice(index, 1);
                localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
                
                if (currentSelectedIndex === index) {
                    currentSelectedIndex = -1;
                } else if (currentSelectedIndex > index) {
                    currentSelectedIndex--;
                }
                
                saveToGoogleDrive();
                renderStockList();
            }
        }

        window.onload = function() {
            renderStockList();
            gapiLoaded();
            gisLoaded();
            
            const priceInputs = ['highPrice', 'lowPrice', 'bouncePrice', 'adjustedPrice'];
            priceInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function() {
                    formatInputPrice(this);
                });
            });
            
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) {
                    clearInterval(waitForInit);
                    await restoreLoginState();
                }
            }, 100);
        };
    </script>
</body>
</html>
